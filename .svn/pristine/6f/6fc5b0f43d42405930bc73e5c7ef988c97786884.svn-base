//remove user
(function ($) {
    $.removems = function () {
        $(".review_tb.user tr td .remove").click(function (e) {
            e.preventDefault();
            var tid = $(this).parents("tr.alist").find(".tid").text();
            var path = $(this).parents("tr.alist").find("#imgpath").val();
            var that = this;
            var obj = {
                "text": "确认删除该用户?",
                "onConfirm": function () {
                    var url = "/admin/removems/";
                    var nthat = that;
                    $.ajax({
                        url: url,
                        data: {"tid": tid, "path": path},
                        method: "GET",
                        dataType: "JSON",
                        success: function (data) {
                            if (data["rr"] == 1) {
                                $(nthat).parents('tr').children('td, th').animate({padding: 0}).wrapInner('<div />').children().slideUp(function () {
                                    $(nthat).closest('tr').remove();
                                });
                                if ($("#review_tb tbody tr.alist").length < 6) {
                                    if (window.location.search) {
                                        window.location.href = "/admin/review/" + window.location.search;
                                    } else {
                                        window.location.href = "/admin/review/";
                                    }
                                }
                            }
                        },
                        error: function (a, b, c) {
                            console.error(a, b, c);
                        }
                    });
                }
            };
            $.confirm(obj);
        });
    }
})($);
//get xsrf cookie
+function ($) {
    $.getCookie = function (name) {
        var r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
        return r ? r[1] : undefined;
    }
}($);
//popup windows:confirm
+function ($) {
    $.confirm = function (obj) {
        /*
         *object passed to this function is like:
         *obj={
         * text:text,
         * onConfirm:function(){},
         * onCancel:function(){},
         * onClose:function(){}
         * }
         *
         */
        var getobj = {
            text: obj.text,
            onConfirm: function () {
                $(document).on("click", ".modal-ct-cf input.cfbtn", function () {
                    $(".modal-bg.active,.modal-ct-cf.active").removeClass("active");
                    Object.keys(obj).indexOf("onConfirm") && typeof obj.onConfirm === "function" ? obj.onConfirm() : "";//confirm callback
                });
            },
            onCancel: function () {
                $(document).on("click", ".modal-ct-cf input.ccbtn", function () {
                    $(".modal-bg.active,.modal-ct-cf.active").removeClass("active");
                    Object.keys(obj).indexOf("onCancel") && typeof obj.onCancel === "function" ? obj.onCancel() : "";//cancel callback
                });
            },
            onClose: function () {
                $(document).on("click", ".cfclose,.modal-bg.active", function () {
                    $(".modal-bg.active,.modal-ct-cf.active").removeClass("active");
                    Object.keys(obj).indexOf("onClose") && typeof obj.onClose === "function" ? obj.onClose() : "";//cancel callback
                });
            },
            displayModal: function () {
                var modalbg = '<div class="modal-bg active"></div>';
                var modalct = '<div class="modal-ct-cf active"><img id="mclose" class="cfclose" src="/static/img/close.png/"><div class="modal-dt-cf"><h3>' + obj.text + '</h3><div class="btn"><input type="button" class="cfbtn" value="确定"/><input type="button" class="ccbtn" value="取消" /></div></div></div>';
                //check if modal bg exists
                !$(".modal-bg").length ? $("body").append(modalbg) : $(".modal-bg").addClass("active");
                !$(".modal-ct-cf").length ? $("body").append(modalct) : $(".modal-ct-cf").addClass("active");
            }
        };
        for (var i in getobj) {
            if (typeof getobj[i] === "function") {
                getobj[i].call();
            }
        }
    }
}($);


+function ($) {
    $.getCaptcha = function (cc) {
        //获取captcha
        $(cc).click(function () {
            var date = new Date();
            var timestamp = date.getTime();
            var url = "/captcha";
            $.ajax({
                url: url,
                data: {tstamp: timestamp},
                method: "GET",
                dataType: "Json",
                beforeSend: function () {
                    $(cc).html("<img style='width:100px;' src='/static/img/loading.gif'");
                },
                success: function (data) {
                    if (data) {
                        var imgsrc = "<img src=" + data['imgsrc'] + "/>";
                        $(cc).html(imgsrc);
                    }
                }
            });
        });
    }
}($);

//ajax get data from server
+function ($) {
    $.ajaxGet = function (url, valobj, tips, btn, crtext, extext) {
        //data[Object.keys(valobj)[0]] = Object.values(valobj)[0];
        $.ajax({
            url: url,
            data: valobj,
            method: "GET",
            dataType: "JSON",
            success: function (data) {
                if (data["cre"] == 0) {
                    $(tips).addClass("cr").text(crtext);
                    $(btn).css("background-color", "").attr("disabled", false);
                    $.checkField("#rvform", btn);

                } else if (data["cre"] == 1) {
                    $(tips).hasClass("cr") ? $(tips).removeClass("cr") : "";
                    $(tips).text(extext);
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                }
            }
        });
    }
}($);
//validate field of form
+function ($) {
    $.validateField = function (obj) {
        var field = obj.selector, tips = obj.tips, btn = obj.button, exp = obj.regexp, url = obj.cburl, callback = obj.callback, key = obj.cbkey, ngtext = obj.ngtext, crtext = obj.crtext, extext = obj.extext, rqtext = obj.rqtext;
        var pat = new RegExp(exp);
        $(field).on({
            "keyup": function () {
                if (!$(this).val()) {
                    $(tips).hasClass("cr") ? $(tips).removeClass("cr") : "";
                    $(tips).text(ngtext);
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                    return;
                }
                var tval = {};
                var turl = url;
                tval[key] = $(this).val();
                if (pat.test($(this).val())) {
                    if (typeof callback != "function") {
                        $(tips).addClass("cr").text(crtext);
                        $(btn).css("background-color", "").attr("disabled", false);
                        if ($(field).attr("name") == "ampwd") {
                            if ($("input[name=cfpwd]").val().length) {
                                if ($(field).val() != $("input[name=cfpwd]").val()) {
                                    $(tips).removeClass("cr").text("密码不一致.");
                                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                                } else {
                                    $(tips).addClass("cr").text("已经输入密码.");
                                }
                            }

                        }
                        if ($(field).attr("name") == "cfpwd") {
                            if ($(field).val() != $("input[name=ampwd]").val()) {
                                $(tips).removeClass("cr").text("密码不一致.");
                                $(btn).css("background-color", "#ccc").attr("disabled", true);
                            } else {
                                $(tips).addClass("cr").text("密码一致.");
                            }
                        }
                        !$(".regform").length ? $.checkField("#rvform", btn) : $.checkField(".regform", btn);
                        return;
                    }
                    $(tips).addClass("cr").text(crtext);
                    $(btn).css("background-color", "").attr("disabled", false);
                    typeof callback == "function" ? callback(turl, tval, tips, btn, crtext, extext) : "";
                } else {
                    $(tips).hasClass("cr") ? $(tips).removeClass("cr") : "";
                    $(tips).text(rqtext);
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                }
            },
            "blur": function () {
                if (!$(this).val()) {
                    $(tips).hasClass("cr") ? $(tips).removeClass("cr") : "";
                    $(tips).text(ngtext);
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                    return;
                }
                var turl = url;
                var tval = {};
                tval[key] = $(this).val();
                if (pat.test($(this).val())) {
                    if (typeof callback != "function") {
                        $(tips).addClass("cr").text(crtext);
                        $(btn).css("background-color", "").attr("disabled", false);
                        if ($(field).attr("name") == "ampwd") {
                            if ($("input[name=cfpwd]").val().length) {
                                if ($(field).val() != $("input[name=cfpwd]").val()) {
                                    $(tips).removeClass("cr").text("密码不一致.");
                                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                                } else {
                                    $(tips).addClass("cr").text("已经输入密码.");
                                }
                            }

                        }
                        if ($(field).attr("name") == "cfpwd") {
                            if ($(field).val() != $("input[name=ampwd]").val()) {
                                $(tips).removeClass("cr").text("密码不一致.");
                                $(btn).css("background-color", "#ccc").attr("disabled", true);
                            } else {
                                $(tips).addClass("cr").text("密码一致.");
                            }
                        }
                        !$(".regform").length ? $.checkField("#rvform", btn) : $.checkField(".regform", btn);
                        return;
                    }
                    $(tips).addClass("cr").text(crtext);
                    $(btn).css({"background-color": "", "color": "#fff"}).attr("disabled", false);
                    typeof callback == "function" ? callback(turl, tval, tips, btn, crtext, extext) : "";

                } else {
                    $(tips).hasClass("cr") ? $(tips).removeClass("cr") : "";
                    $(tips).text(rqtext);
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                }
            }
        });
    }
}($);
+function($){
    $.loginSettings = function(s){
        var selector = $(s);
        return {
            "amname": {
                "selector": selector.find("input[name=amname]"),
                "tips": selector.find("input[name=amname]").siblings(".tips"),
                "button": "#adlgform .lgbtn",
                "regexp": /^[a-zA-Z0-9]{8,16}$/,
                "cburl": "",//callback url
                "callback": "",//callback function
                "cbkey": "",//key name in callback obj
                "ngtext": "请输入用户名.",//when input is empty
                "crtext": "已输入用户名.",//condition is met
                "extext": "",//text shows when already exists
                "rqtext": "请输入8-16位用户名,大小写字母或数字."
            },
            "cfpwd": {
                "selector": selector.find("input[name=ampwd]"),
                "tips": selector.find("input[name=ampwd]").siblings(".tips"),
                "button": "#adlgform .lgbtn",
                "regexp": /^[a-zA-Z0-9]{6,16}$/,
                "cburl": "",//callback url
                "callback": "",//callback function
                "cbkey": "",//key name in callback obj
                "ngtext": "请输入密码.",//when input is empty
                "crtext": "已输入密码.",//condition is met
                "extext": "",//text shows when already exists
                "rqtext": "请输入6-16位登陆密码,大小写字母或数字."
            },
            "captcha": {
                "selector": selector.find("input[name=captcha]"),
                "tips": selector.find("input[name=captcha]").siblings(".tips"),
                "button": "#adlgform .lgbtn",
                "regexp": /\w{4}/,
                "cburl": "/checkcaptcha/",//callback url
                "callback": $.ajaxGet,//callback function
                "cbkey": "cc",//key name in callback obj
                "ngtext": "请输入图中验证码.",//when input is empty
                "crtext": "验证码正确.",//condition is met
                "extext": "验证码出错",//text shows when already exists
                "rqtext": "请输入图片验证码."
            }
        }
    }
}($);

+function ($) {
    $.checkField = function (form, btn) {
        $(form + " " + "input[type=text]," + form + " " + "input[type=file]").each(function (i, t) {
            if ($(t).val().length == 0) {
                if ($(t).attr("name") != "memo") {
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                }
                return;
            } else if ($(t).attr("type") == "text" && !$(t).siblings(".tips").hasClass("cr") && $(t).siblings(".tips").text().length) {
                $(btn).css("background-color", "#ccc").attr("disabled", true);
                return;
            }
        });
        $(form + " " + "input[type=file]").on("change", function () {
            $(form + " " + "input[type=file]," + form + " " + "input[type=text]").each(function (i, t) {
                if ($(t).val().length == 0) {
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                    return;
                } else if ($(t).attr("type") == "text" && !$(t).siblings(".tips").hasClass("cr") && $(t).siblings(".tips").text().length) {
                    $(btn).css("background-color", "#ccc").attr("disabled", true);
                    return;
                }
            });
        });
    }

}($);
+function($){
    $.processForm = function(selector,type){
        $(selector).empty();
        var p = /\[(.*)\]/;
        var cu = p.exec($("#wu").text())[1];
        if(type == "1"){
            //添加机房机器
            var html = "<div class='frow'> <label>所属机房:</label><select id='loca' name='loca'><option hid='厦门哈曼尼'selected>厦门哈曼尼</option><option hid='东莞枫华园'>东莞枫华园</option><option hid='浙江绍兴'>浙江绍兴</option><option hid='香港机房'>香港机房</option><option hid='浙江杭州'>浙江杭州</option><option hid='美国机房'>美国机房</option></select></div>";
            html +="<div class='frow'> <label>机柜编号:</label><input type='text' id='c_num' name='c_num' maxlength='10'/></div>";
            html +="<div class='frow'> <label>利联编号:</label><input type='text' id='m_num' name='m_num' maxlength='10'/></div>";
             html +="<div class='frow'> <label>其它编号:</label><input type='text' id='wy_m_num' name='wy_m_num' maxlength='10'/></div>";
            html +="<div class='frow'> <label>IP地址:</label><input type='text' id='ips' name='ips' maxlength='50' pattern='[0-9.]*'/></div>";
            html +="<div class='frow'><label>机器配置:</label><input type='text' id='config' name='config' maxlength='20' pattern='[A-Za-z0-9]{5,20}'/></div>";
            html +="<div class='frow'> <label>带宽:</label><input type='text' id='bw' name='bw' maxlength='5' pattern='[0-9A-Z]{2,8}'/></div>";
            html += "<div class='frow'><label>机器状态:</label><select id='status' name='status'><option value='空闲' selected>空闲</option><option value='租用'>租用</option><option value='托管'>托管</option><option value='试用'>试用</option></select></div>";
            html += "<div class='frow'><label>备注:</label><input type='text' name='memo' id='memo'/></div>";
        }else if(type =='2'){
            //添加订单
            //var html = "<div class='frow'> <label>所属机房:</label><select id='loca' name='loca'><option value='厦门哈曼尼'selected>厦门哈曼尼</option><option value='东莞枫华园'>东莞枫华园</option></select></div>";
            //html +="<div class='frow'><label>机器配置:</label><input type='text' id='config' name='config' maxlength='20' pattern='[A-Za-z0-9]{5,20}'/></div>";
            //html +="<div class='frow'> <label>带宽:</label><input type='text' id='bw' name='bw' maxlength='5' pattern='[0-9A-Z]{2,8}'/></div>";
            var html = "<div class='frow'><label>服务类型:</label><select id='stype' name='stype'><option value='租用' selected>租用</option><option value='托管'>托管</option><option value='试用'>试用</option></select></div>";
            html +="<div class='frow'> <label>IP地址:</label><input type='text' id='ips' name='ips' maxlength='50' pattern='[0-9.]*'/></div>";
            html +="<div class='frow'> <label>业务员:</label><input type='text' id='sales' name='sales' maxlength='10' pattern='^[\u4e00-\u9fa5]{2,4}' readonly='readonly' value='"+cu+"'/></div>";
            html +="<div class='frow'> <label>客户账号:</label><input type='text' id='cid' name='cid' maxlength='10' pattern='^[\u4e00-\u9fa5]{2,4}'/></div>";
            html +="<div class='frow'> <label>订单金额:</label><input type='text' id='pm' name='pm' maxlength='10' pattern='\d{1,10}'/></div>";
            html +="<div class='frow'><label>出机时间:</label><input type='date' name='sdt'/></div>";
            html +="<div class='frow'><label>服务时间:</label><select name='msl' id='msl'><option value='1'>1个月</option><option value='3'>1个季度</option><option value='6'>半年</option><option value='12'>1年</option></select></div>";
            html += "<div class='frow'><label>备注:</label><input type='text' name='memo' id='memo'/></div>";
        }
        $(selector).append(html);

    }
}($);
+function($){
   $.globaltips = function (type,text,closecb) {
       var html="";
       html += "<div class='tmodal'></div>";
       if(type=="success"){
           html += "<div class='tipct'><i class='fa fa-check-circle-o fa-3x'></i><p class='desc'>"+text+"</p></div>";
       }
       else if(type=="error"){
           html += "<div class='tipct'><i class='fa fa-times-circle-o'></i><p class='desc'>"+text+"</p></div>";
       }
       !$(".tmodal").length?$("body").append(html):"";
       $(".tmodal").addClass("active");
       window.setTimeout(function() {
       $(".tmodal").removeClass("active").remove();
       $(".tipct").remove();
       typeof  closedb == "function"?closecb.call():"";
       },2000);
   }
}($);

+function($){
   $.tips = function(selector,text,type){
       //type 1 correct,type2 error,type 3 info
       var chtml = "<i class='fa fa-check-circle-o'></i>";
       var ehtml = "<i class='fa fa-times-circle-o fa-2x'></i>";
       var ihtml = "<i class='fa fa-info-circle fa-2x'></i>";
       type == 1?$(chtml).insertBefore(selector+" span"):type == 2?$(ehtml).insertBefore(selector+ " span"):$(ihtml).insertBefore(selector+" span");
       $(selector+" span").text(text);
       window.setTimeout(function(){
           $(selector+" span").empty();
           $(selector+" i").remove();
       },3000);
   }
}($);
+function($){
   $.checkempty = function (form,text) {
       var c=0;
       $(form).find("input[type='text'],input[type='date']").not("#memo").each(function(i,t){
           if (!$(t).val().length){
               //console.log(c);
               c==0?$.tips(form+" .tips",text,"2"):"";
               c==0?c+=1:"";
               return;
           }
       });
       return c;
   }
}($);
+function(){
    $.displayOrderDetails = function(selector,data,type){
        var html = "";
        if(type=="details"){
            //order part
            html += "<div class='frow'><label>订单id:</label><input type='text' readonly='readonly' name='orderid' id='orderid' value='"+data[0]+"'/></div>";
            html += "<div class='frow'><label>订单金额:</label><input type='text' readonly='readonly' name='pm' id='pm' value='"+data[3]+"'/></div>";
            html += "<div class='frow'><label>服务类型:</label><input type='text' readonly='readonly' name='stype' id='stype' value='"+data[29]+"'/></div>";
            html += "<div class='frow'><label>出机时间:</label><input type='text' readonly='readonly' name='sd' id='sd' value='"+data[4]+"'/></div>";
            html += "<div class='frow'><label>到期时间:</label><input type='text' readonly='readonly' name='ed' id='ed' value='"+data[5]+"'/></div>";
            html += "<div class='frow'><label>客户所属:</label><input type='text' readonly='readonly' name='bl' id='bl' value='"+data[7]+"'/></div>";
            html += "<div class='frow'><label>审核人:</label><input type='text' readonly='readonly' name='ad' id='ad' value='"+data[8]+"'/></div>";
            html += "<div class='frow'><label>订单备注:</label><input type='text' readonly='readonly' name='omemo' id='omemo' value='"+data[9]+"'/></div>";
            //client part
            html += "<div class='frow'><label>客户账号:</label><input type='text' readonly='readonly' name='c_ac' id='c_ac' value='"+data[2]+"'/></div>";
            html += "<input type='hidden' readonly='readonly' name='cid' id='cid' value='"+data[10]+"'/></div>";
            html += "<div class='frow'><label>客户姓名:</label><input type='text' readonly='readonly' name='cname' id='cname' value='"+data[13]+"'/></div>";
            html += "<div class='frow'><label>客户电话:</label><input type='text' readonly='readonly' name='cphone' id='cphone' value='"+data[15]+"'/></div>";
            html += "<div class='frow'><label>客户QQ:</label><input type='text' readonly='readonly' name='cqq' id='cqq' value='"+data[20]+"'/></div>";
            //machine part
            html += "<input type='hidden' readonly='readonly' name='mid' id='mid' value='"+data[22]+"'/></div>";
            html += "<div class='frow'><label>机器IP:</label><input type='text' readonly='readonly' name='mip' id='mip' value='"+data[23]+"'/></div>";
            html += "<div class='frow'><label>机房:</label><input type='text' readonly='readonly' name='mloca' id='mloca' value='"+data[24]+"'/></div>";
            html += "<div class='frow'><label>机柜编号:</label><input type='text' readonly='readonly' name='mc' id='mc' value='"+data[25]+"'/></div>";
            html += "<div class='frow'><label>利联编号:</label><input type='text' readonly='readonly' name='mnum' id='mnum' value='"+data[26]+"'/></div>";
            html += "<div class='frow'><label>其它编号:</label><input type='text' readonly='readonly' name='onum' id='onum' value='"+data[27]+"'/></div>";
            html += "<div class='frow'><label>带宽:</label><input type='text' readonly='readonly' name='bw' id='bw' value='"+data[28]+"'/></div>";
            html += "<div class='frow'><label>机器配置:</label><input type='text' readonly='readonly' name='bw' id='bw' value='"+data[31]+"'/></div>";
            html += "<div class='frow'><label>机器备注:</label><input type='text' readonly='readonly' name='st' id='st' value='"+data[33]+"'/></div>";
        }else if(type == "renew"){
            //order part
            html += "<div class='frow'><label>订单id:</label><input type='text' readonly='readonly' name='orderid' id='orderid' value='"+data[0]+"'/></div>";
            html += "<div class='frow'><label>订单金额:</label><input type='text' name='pm' lpm = '"+data[3]+"'id='pm'/>"+"<p class='otip'>原订单付款:"+data[3]+"元</p></div>";
            html += "<div class='frow'><label>服务类型:</label><input type='text' readonly='readonly' name='stype' id='stype' value='"+data[29]+"'/></div>";
            html += "<div class='frow'><label>出机时间:</label><input type='text' readonly='readonly' name='sd' id='sd' value='"+data[4]+"'/></div>";
            html += "<div class='frow'><label>续期:</label><select name='rnt' id='rnt'><option value='1'>1个月</option><option value='3'>1个季度</option><option value='6'>半年</option><option value='12'>1年</option></select><p class='otip exd' exd='"+data[5]+"'>原计划到期时间:"+data[5]+"</p></div>";
            html += "<input type='hidden' name = 'cid' id = 'cid' value='"+data[10]+"'/>";
            html += "<div class='frow'><label>客户账号:</label><input type='text' readonly='readonly' name='c_ac' id='c_ac' value='"+data[2]+"'/></div>";
            html += "<div class='frow'><label>客户姓名:</label><input type='text' readonly='readonly' name='cname' id='cname' value='"+data[13]+"'/></div>";
            html += "<div class='frow'><label>客户所属:</label><input type='text' readonly='readonly' name='bl' id='bl' value='"+data[7]+"'/></div>";
            html += "<div class='frow'><label>审核人:</label><input type='text' readonly='readonly' name='ad' id='ad' value='"+data[8]+"'/></div>";
            html += "<div class='frow'><label>订单备注:</label><input type='text' name='omemo' id='omemo' value='"+data[9]+"'/></div>";
        }
        $(selector).append(html);
    }
}($);
+function ($) {
   $.closeModal =function(url){
       $(".modal-bg.active,.mclose").on("click.last", function () {
                $("body").css("overflow", "auto");
                $(".modal-ct").animate({top: -200, opacity: 0.4}, 200, function () {
                    $(this).fadeOut();
                    $(".modal-bg.active,div[class^=modal-ct].active").removeClass("active");
                    if (window.location.search) {
                        window.location.href = url + window.location.search;
                    } else {
                        window.location.href = url;
                    }
                });
            });
   }
}($);
+function($){
    $(document).ready(function(){
       $.getCaptcha(".ccha");
       $("#nav ul li.add-machines").click(function(){
           $(this).addClass("active").siblings().removeClass("active");
           $.processForm("#add_machines .data","1");
            $(".modal-ct-s-1,.modal-bg").toggleClass("active");
            $(".modal-ct-s-1.active").css("top",$(window).scrollTop()+29);
            $("body").css("overflow", "hidden");
            //取消模态框vnbtn
            $(".modal-bg.active,.mclose").on("click.last", function () {
                $("body").css("overflow", "auto");
                $(".modal-ct").animate({top: -200, opacity: 0.4}, 200, function () {
                    $(this).fadeOut();
                    $(".modal-bg.active,div[class^=modal-ct].active").removeClass("active");
                    if (window.location.search) {
                        window.location.href = "/admin/all-machines/" + window.location.search;
                    } else {
                        window.location.href = "/admin/all-machines/";
                    }
                });

            });

       });
       $("#nav ul li.add-orders").click(function(){
           $(this).addClass("active").siblings().removeClass("active");
           $.processForm("#add_orders .data","2");
            $(".modal-ct-s-2,.modal-bg").toggleClass("active");
            $(".modal-ct-s-2.active").css("top",$(window).scrollTop()+29);
            $("body").css("overflow", "hidden");
            //取消模态框vnbtn
            $(".modal-bg.active,.mclose").on("click.last", function () {
                $("body").css("overflow", "auto");
                $(".modal-ct-s-2").animate({top: -200, opacity: 0.4}, 200, function () {
                    $(this).fadeOut();
                    $(".modal-bg.active,div[class^=modal-ct].active").removeClass("active");
                    if (window.location.search) {
                        window.location.href = "/admin/orders/" + window.location.search;
                    } else {
                        window.location.href = "/admin/orders/";
                    }
                });

            });
       });
    });

    //submit new machine info
    $(".m_addbtn").click(function(e){
        e.preventDefault();
        //check if input value is empty
        var empty = $.checkempty("#add_machines","机器信息不能为空");
        //console.log(empty);
        if(!empty){
        $(".loadding").show();
        $.post("/admin/machines/",$("#add_machines").serialize(),function(data){
            var data = JSON.parse(data);
            if(data["rs"] == "1024"){
                $(".modal-ct-s-1 .modal-dt").animate({scrollTop: 0}, function (){
                    $("#add_machines .data").empty();
                    $.processForm("#add_machines .data","1");
                    $(".loadding").hide();
                });
            }else if(data.rs=="1025"){
                    $.tips("#add_machines .tips","提交机器信息到服务器出错.","2");
            }
        });
        }
    });
    $(".o_addbtn").click(function(e){
        e.preventDefault();
        //check if input value is empty
        var empty = $.checkempty("#add_orders","订单信息不能为空");
        console.log(empty);
        if(!empty){
            $(".loadding").show();
            $.post("/admin/orders/",$("#add_orders").serialize(),function(data){
            var data = JSON.parse(data);
            if(data["rs"] == "1026"){
                $.tips("#add_orders .tips","订单提交成功.","1");
                $(".modal-ct-s-2 .modal-dt").animate({scrollTop: 0}, function (){
                    $("#add_orders .data").empty();
                    $.processForm("#add_orders .data","2");
                    $(".loadding").hide();
                });
            }else if(data.rs=="1027"){
                    $.tips("#add_orders .tips","提交订单信息到服务器出错.","2");
            }
        });
        }
    });
    $(".orders_tb tr td .modify").click(function(){
        var oid = $(this).parents("tr").find(".tid").text().trim();
        $(".loadding").show();
        $.get("/admin/order/modify/"+oid,function(data){
            var data = JSON.parse(data)["order"];
            if(data){
                $("#add_orders .data").empty();
                if(!data[8]){
                    var ihtml = '<input type="submit" class="auditbtn sbtn" value="审核" style=""/>';
                }else{
                    var ihtml = '<input type="submit" disabled="disabled" class="auditbtn sbtn" value="审核" style=""/>';
                }

                $(ihtml).insertAfter("#oform .n_addbtn");
                $.displayOrderDetails("#oform .data",data,"details");
                //hide submit btn
                $("#oform .n_addbtn").hide();
                $(".modal-ct-s-4,.modal-bg").toggleClass("active");
                $(".modal-ct-s-4.active").css("top",$(window).scrollTop()+29);
                $("body").css("overflow", "hidden");
                $(".loadding").hide();
                //when auditbtn is click
                $("#oform .auditbtn").click(function(){
                    var tstr = $("#wu").text();
                    var pat = /\[(.*)\]/;
                    var cu = pat.exec(tstr)[1];
                    $.post("/admin/order/audit/",{"oid":oid,"auditor":cu,"_xsrf":$.getCookie("_xsrf")},function(data){
                        var data = JSON.parse(data);
                        if (data["rs"]=="1032"){
                            $(this).attr("disabled",true).val("已审核.").css({"background":"orange","color":"#fff"});
                        }else if(data["rs"]=="1033"){
                            $(this).attr("disabled",true).val("审核失败.").css({"background":"#ccc","color":"#fff"});
                        }
                    })

                });
                $.closeModal("/admin/orders/");
                /*$(".modal-ct-s-4 .modal-dt").animate({scrollTop: 0}, function (){

                });*/
            }
        });
    });
    $(".orders_tb tr td .renew").click(function(){
        var oid = $(this).parents("tr").find(".tid").text().trim();
        $("#oform .btn").addClass("renew");
        $(".loadding").show();
        $.get("/admin/order/modify/"+oid,function(data){
            var data = JSON.parse(data)["order"];
            if(data){
                $("#add_orders .data").empty();
                $.displayOrderDetails("#oform .data",data,"renew");
                $(".modal-ct-s-4,.modal-bg").toggleClass("active");
                $(".modal-ct-s-4.active").css("top",$(window).scrollTop()+29);
                $("body").css("overflow", "hidden");
                $(".loadding").hide();
                $.closeModal("/admin/orders/");
                /*$(".modal-ct-s-4 .modal-dt").animate({scrollTop: 0}, function (){

                });*/
                $("#oform .btn.renew").click(function(e){
                    e.preventDefault();
                    var tid = $("#oform #orderid").val();
                    var pm = parseInt($("#oform #pm").val())+parseInt($("#oform #pm").attr("lpm"));//latest payment value
                    var tpm = parseInt($("#oform #pm").val());
                    var renew = $("#oform #rnt").val();
                    var memo = $("#oform #omemo").val();
                    var exd = $("#oform .otip.exd").attr("exd");
                    var cid = $("#oform #cid").val();
                    $(this).attr("disabled",true).val("正在提交...").css({"background":"#ccc","color":"#fff"});
                    var that = $(this);
                    $.post("/admin/order/renew/",{"tid":tid,"pm":pm,"renew":renew,"memo":memo,"exd":exd,"cid":cid,"tpm":tpm,"_xsrf":$.getCookie("_xsrf")},function(data){
                        var data = Json.parse(data);
                        if(data["rs"]=="1030"){
                            $.globaltips("success","订单续期成功!",function(){
                                $(".modal-ct-s-4").animate({top: -2000, opacity: 0.4}, 200, function () {
                                $(this).fadeOut();
                                if (window.location.search) {
                                   window.location.href = "/admin/orders/" + window.location.search;
                                } else {
                                    window.location.href = "/admin/orders/";
                                }
                                })
                            });
                        }else if(data["rs"]=="1031"){
                            $.globaltips("error","订单续期失败!");
                            that.val("提交失败!");
                        }
                    });
                });
            }
        });
    });
}($);